#!../sapi/cli/php
<?php

namespace Mgrunder\Fuzzer;

require_once __DIR__ . '/' . '../vendor/autoload.php';

use Mgrunder\Fuzzer\Cmd;

function validateReply(array $reply): bool {
    return isset($reply['query'])           &&
           isset($reply['redis'])           &&
           isset($reply['relay'])           &&
           isset($reply['relay']['result']) &&
           isset($reply['redis']['result']);
}

function randChance(float $percent): bool {
    if ($percent <= 0.0)
        return false;
    else if ($percent >= 100.0)
        return true;

    return mt_rand() / mt_getrandmax() < ($percent / 100.0);
}

$opt = getopt('', ['host:', 'port:', 'grace-period:', 'delay:', 'kill:',
                   'flush', 'del', 'trim:', 'keys:', 'mems:']);
$host = $opt['host'] ?? '127.0.0.1';
$port = $opt['port'] ?? 8080;
$grace = (float)($opt['grace-period'] ?? 1.0);
$delay = (float)($opt['delay'] ?? 0.0);
$delay_us = (int)($delay * 1_000_000);
$kill = (float)($opt['kill'] ?? 0.0);
$flush = isset($opt['flush']);
$del = isset($opt['del']);
$trim = (int)($opt['trim'] ?? -1);
$keys = (int)($opt['keys'] ?? 100);
$mems = (int)($opt['mems'] ?? 100);

$totals = [];
$t1 = $st = microtime(true);
$it = 0;
$retries = 0;
$kills = 0;
$trimmed = 0;

$cfg = new FuzzConfig('localhost', 8080, $keys, $mems);
$reg = new Cmd\Registry($cfg, $flush, $del);
$clients = new Clients($host, $port);
$trimmer = new Trimmer($trim);
$stats = new Stats($host, $port);
$redis = new \Redis(['host' => 'localhost', 'port' => 6379]);

printf("Commands: %s\n", implode(', ', $reg->commandNames()));
printf("Starting fuzzing against %s:%d\n\n", $host, $port);

/* Output all of the options being used in a comma sepeated line */
printf("Keys: %d, Members: %d, Grace Period: %.2f sec, Delay: %.2f sec, Kill Chance: %.2f%%, Trim Threshold: %d, FlushDB: %s, DEL before write: %s\n\n",
       $keys, $mems, $grace, $delay, $kill, $trim, $flush ? 'Yes' : 'No',
       $del ? 'Yes' : 'No'
);

while (++$it) {
    if (randChance($kill)) {
        $kills += $clients->kill(null);
    }

    $cmd  = $reg->randomCmd();
    $args = $cmd->nextArgs();

    if ( ! isset($totals[$cmd->name]))
        $totals[$cmd->name] = 0;
    $totals[$cmd->name] += 1;

    $cmd_time  = microtime(true);
    $res = $cmd->exec($args);

    if (!($cmd->flags() & Cmd\Cmd::READ)) {
        continue;
    }

    assert(validateReply($res), 'Invalid reply structure');

    do {
        $relay_res = $res['relay']['result'];
        $redis_res = $res['redis']['result'];
        if ($relay_res === $redis_res)
            break;

        $retries += 1;
        usleep(10_000);
    } while (microtime(true) - $cmd_time < $grace);

    if ($relay_res !== $redis_res) {
        printf("[%d] Mismatch\n", $it);
        print_r($res);
        exit(1);
    }

    if (($et = microtime(true)) - $st >= 1.0) {
        $trimmed += $trimmer->trim();

        $preamble = sprintf("[%d]", $it);
        arsort($totals);

        $info = $redis->info();
        $redis_used_mem = $info['used_memory_human'] ?? 'N/A';

        $info = $stats->exec([]);
        [$relay_used_mem, $relay_total_mem] = [
            $info['memory']['used'],
            $info['memory']['total']
        ];

        [$relay_requests, $relay_hits, $relay_misses] = [
            $info['stats']['requests'],
            $info['stats']['hits'],
            $info['stats']['misses']
        ];

        printf("%s Commands (%.2f/sec). Retries: %d, Kills: %d, Trimmed: %d\n",
               $preamble, $it / ($et - $t1), $retries, $kills, $trimmed);
        printf("%s Totals: %s\n", str_pad('', strlen($preamble), ' '),
               json_encode($totals));
        printf("%s Relay IDs: [%s]\n", $preamble, implode(', ', $clients->ids()));
        printf("%s Last result: %s === %s\n", str_pad('', strlen($preamble), ' '),
               json_encode($redis_res, true), json_encode($relay_res, true));
        printf("%s Redis Memory: %s, Relay: [%s/%s]\n\n",
               str_pad('', strlen($preamble), ' '),
               $redis_used_mem, number_format($relay_used_mem),
               number_format($relay_total_mem));
        printf("%s Relay Requests: %s, Hits: %s, Misses: %s\n\n",
               str_pad('', strlen($preamble), ' '),
               number_format($relay_requests),
               number_format($relay_hits),
               number_format($relay_misses)
        );
        $st = $et;
    }

    if ($delay_us > 0)
        usleep($delay_us);
}

//array(3) {
//  ["query"]=>
//  array(2) {
//    ["cmd"]=>
//    string(3) "get"
//    ["args"]=>
//    array(1) {
//      [0]=>
//      string(9) "string:10"
//    }
//  }
//  ["redis"]=>
//  array(4) {
//    ["status"]=>
//    string(2) "ok"
//    ["pid"]=>
//    int(1729578)
//    ["class"]=>
//    string(5) "redis"
//    ["result"]=>
//    bool(false)
//  }
//  ["relay"]=>
//  array(4) {
//    ["status"]=>
//    string(2) "ok"
//    ["pid"]=>
//    int(1729578)
//    ["class"]=>
//    string(5) "relay"
//    ["result"]=>
//    bool(false)
//  }
//}
//array(2) {
//  ["query"]=>
//  array(2) {
//    ["cmd"]=>
//    string(3) "del"
//    ["args"]=>
//    array(1) {
//      [0]=>
//      array(10) {
//        [0]=>
//        string(6) "zset:3"
//        [1]=>
//        string(6) "list:2"
//        [2]=>
//        string(8) "string:6"
//        [3]=>
//        string(5) "set:2"
//        [4]=>
//        string(6) "zset:6"
//        [5]=>
//        string(5) "set:1"
//        [6]=>
//        string(8) "string:1"
//        [7]=>
//        string(8) "string:4"
//        [8]=>
//        string(6) "zset:6"
//        [9]=>
//        string(8) "string:6"
//      }
//    }
//  }
//  ["redis"]=>
//  array(4) {
//    ["status"]=>
//    string(2) "ok"
//    ["pid"]=>
//    int(1729578)
//    ["class"]=>
//    string(5) "redis"
//    ["result"]=>
//    int(1)
//  }
//}
//array(2) {
//  ["query"]=>
//  array(2) {
//    ["cmd"]=>
//    string(7) "flushdb"
//    ["args"]=>
//    array(0) {
//    }
//  }
//  ["redis"]=>
//  array(4) {
//    ["status"]=>
//    string(2) "ok"
//    ["pid"]=>
//    int(1729579)
//    ["class"]=>
//    string(5) "redis"
//    ["result"]=>
//    bool(true)
//  }
//}
//array(3) {
//  ["query"]=>
//  array(2) {
//    ["cmd"]=>
//    string(3) "get"
//    ["args"]=>
//    array(1) {
//      [0]=>
//      string(8) "string:2"
//    }
//  }
//  ["redis"]=>
//  array(4) {
//    ["status"]=>
//    string(2) "ok"
//    ["pid"]=>
//    int(1729579)
//    ["class"]=>
//    string(5) "redis"
//    ["result"]=>
//    bool(false)
//  }
//  ["relay"]=>
//  array(4) {
//    ["status"]=>
//    string(2) "ok"
//    ["pid"]=>
//    int(1729578)
//    ["class"]=>
//    string(5) "relay"
//    ["result"]=>
//    bool(false)
//  }
//}
//array(3) {
//  ["query"]=>
//  array(2) {
//    ["cmd"]=>
//    string(7) "hgetall"
//    ["args"]=>
//    array(1) {
//      [0]=>
//      string(6) "hash:9"
//    }
//  }
//  ["redis"]=>
//  array(4) {
//    ["status"]=>
//    string(2) "ok"
//    ["pid"]=>
//    int(1729579)
//    ["class"]=>
//    string(5) "redis"
//    ["result"]=>
//    array(0) {
//    }
//  }
//  ["relay"]=>
//  array(4) {
//    ["status"]=>
//    string(2) "ok"
//    ["pid"]=>
//    int(1729579)
//    ["class"]=>
//    string(5) "relay"
//    ["result"]=>
//    array(0) {
//    }
//  }
//}
//array(2) {
//  ["query"]=>
//  array(2) {
//    ["cmd"]=>
//    string(4) "sadd"
//    ["args"]=>
//    array(11) {
//      [0]=>
//      string(5) "set:8"
//      [1]=>
//      string(9) "member:10"
//      [2]=>
//      string(8) "member:9"
//      [3]=>
//      string(9) "member:10"
//      [4]=>
//      string(8) "member:1"
//      [5]=>
//      string(8) "member:3"
//      [6]=>
//      string(8) "member:9"
//      [7]=>
//      string(9) "member:10"
//      [8]=>
//      string(8) "member:2"
//      [9]=>
//      string(8) "member:8"
//      [10]=>
//      string(8) "member:4"
//    }
//  }
//  ["relay"]=>
//  array(4) {
//    ["status"]=>
//    string(2) "ok"
//    ["pid"]=>
//    int(1729579)
//    ["class"]=>
//    string(5) "relay"
//    ["result"]=>
//    int(7)
//  }
//}
//array(2) {
//  ["query"]=>
//  array(2) {
//    ["cmd"]=>
//    string(4) "sadd"
//    ["args"]=>
//    array(11) {
//      [0]=>
//      string(5) "set:6"
//      [1]=>
//      string(8) "member:2"
//      [2]=>
//      string(8) "member:6"
//      [3]=>
//      string(8) "member:7"
//      [4]=>
//      string(9) "member:10"
//      [5]=>
//      string(8) "member:2"
//      [6]=>
//      string(8) "member:2"
//      [7]=>
//      string(8) "member:9"
//      [8]=>
//      string(8) "member:9"
//      [9]=>
//      string(8) "member:2"
//      [10]=>
//      string(8) "member:4"
//    }
//  }
//  ["redis"]=>
//  array(4) {
//    ["status"]=>
//    string(2) "ok"
//    ["pid"]=>
//    int(1729579)
//    ["class"]=>
//    string(5) "redis"
//    ["result"]=>
//    int(6)
//  }
//}
//array(2) {
//  ["query"]=>
//  array(2) {
//    ["cmd"]=>
//    string(3) "set"
//    ["args"]=>
//    array(2) {
//      [0]=>
//      string(8) "string:3"
//      [1]=>
//      string(7) "value:1"
//    }
//  }
//  ["relay"]=>
//  array(4) {
//    ["status"]=>
//    string(2) "ok"
//    ["pid"]=>
//    int(1729579)
//    ["class"]=>
//    string(5) "relay"
//    ["result"]=>
//    bool(true)
//  }
//}
//array(2) {
//  ["query"]=>
//  array(2) {
//    ["cmd"]=>
//    string(3) "del"
//    ["args"]=>
//    array(1) {
//      [0]=>
//      array(10) {
//        [0]=>
//        string(6) "list:8"
//        [1]=>
//        string(6) "zset:9"
//        [2]=>
//        string(6) "list:4"
//        [3]=>
//        string(5) "set:4"
//        [4]=>
//        string(8) "string:7"
//        [5]=>
//        string(6) "list:5"
//        [6]=>
//        string(6) "list:7"
//        [7]=>
//        string(5) "set:1"
//        [8]=>
//        string(6) "hash:8"
//        [9]=>
//        string(6) "zset:7"
//      }
//    }
//  }
//  ["redis"]=>
//  array(4) {
//    ["status"]=>
//    string(2) "ok"
//    ["pid"]=>
//    int(1729579)
//    ["class"]=>
//    string(5) "redis"
//    ["result"]=>
//    int(0)
//  }
//}
//array(3) {
//  ["query"]=>
//  array(2) {
//    ["cmd"]=>
//    string(8) "smembers"
//    ["args"]=>
//    array(1) {
//      [0]=>
//      string(5) "set:3"
//    }
//  }
//  ["redis"]=>
//  array(4) {
//    ["status"]=>
//    string(2) "ok"
//    ["pid"]=>
//    int(1729579)
//    ["class"]=>
//    string(5) "redis"
//    ["result"]=>
//    array(0) {
//    }
//  }
//  ["relay"]=>
//  array(4) {
//    ["status"]=>
//    string(2) "ok"
//    ["pid"]=>
//    int(1729579)
//    ["class"]=>
//    string(5) "relay"
//    ["result"]=>
//    array(0) {
//    }
//  }
//}
//
